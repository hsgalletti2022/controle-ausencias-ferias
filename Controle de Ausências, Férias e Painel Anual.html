<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle de Ausências, Férias e Painel Anual</title>
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<style>
body { font-family: Arial, sans-serif; margin:20px; text-align:center; }
h1 { margin-bottom:10px; }
#tabs { margin-bottom:10px; }
.tab-button { padding:8px 15px; margin:0 5px; cursor:pointer; font-size:14px; }
.active-tab { background-color:#3788d8; color:#fff; border-radius:4px; }
#calendar-container { display:block; }
#calendar { max-width:1000px; margin:20px auto; }
button, select, input { margin:5px; padding:6px 10px; font-size:14px; }
.modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.5);}
.modal-content { background-color:#fefefe; margin:10% auto; padding:20px; border-radius:8px; width:320px; text-align:left; position:relative;}
.close { position:absolute; top:10px; right:15px; font-size:20px; cursor:pointer; }
.modal input, .modal select { width:100%; margin:5px 0 15px 0; padding:8px; box-sizing:border-box; }
.modal button { width:100%; }
#legend, #stats { max-width:900px; margin:10px auto; text-align:left; display:flex; flex-wrap:wrap; justify-content:center; }
.legend-item { margin:5px 10px; display:flex; align-items:center; font-size:14px; }
.color-box { width:15px; height:15px; margin-right:5px; border:1px solid #000; }

/* Painel anual */
#dashboardContainer { display:none; }
#dashboard { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; max-width:1200px; margin:0 auto; }
.calendar-mini { border:1px solid #ccc; border-radius:6px; padding:5px; background:#fafafa; }
.month-title { font-weight:bold; background:#eee; border-radius:4px; padding:3px; margin-bottom:4px; }
</style>
</head>
<body>

<h1>Controle de Ausências, Férias e Painel Anual</h1>

<div id="tabs">
  <button class="tab-button active-tab" id="tabAusencias">Ausências</button>
  <button class="tab-button" id="tabFerias">Férias</button>
  <button class="tab-button" id="tabDashboard">Painel Anual</button>
</div>

<div id="controls">
  <button id="openModal">Adicionar</button>
  <button id="exportPdf">Exportar PDF</button>
  <select id="filtroFuncionario"><option value="all">Mostrar Todos</option></select>
  <input type="text" id="buscaFuncionario" placeholder="Buscar por nome...">
  <select id="viewSelect">
    <option value="dayGridMonth">Mensal</option>
    <option value="timeGridWeek">Semanal</option>
    <option value="timeGridDay">Diária</option>
  </select>
</div>

<div id="legend"></div>
<div id="stats"></div>
<div id="calendar-container"><div id="calendar"></div></div>

<!-- Painel anual -->
<div id="dashboardContainer">
  <div id="controlsDashboard">
    <button id="exportDashboardPdf">Exportar PDF</button>
    <select id="anoSelect"></select>
  </div>
  <div id="legendDashboard"></div>
  <div id="dashboard"></div>
</div>

<!-- Modal -->
<div id="modal" class="modal">
  <div class="modal-content">
    <span class="close" id="closeModal">&times;</span>
    <h3 id="modalTitle">Adicionar</h3>
    <label>Nome do Funcionário:</label>
    <input type="text" id="nomeFuncionario" placeholder="Ex: João">
    <label id="labelData1">Data Início:</label>
    <input type="date" id="dataInicio">
    <label id="labelData2" style="display:none">Data Fim:</label>
    <input type="date" id="dataFim" style="display:none">

    <!-- Motivo da ausência -->
    <div id="motivoContainer">
      <label>Motivo da Ausência:</label>
      <select id="motivoSelect">
        <option value="">Selecione...</option>
        <option value="Abonada">Abonada</option>
        <option value="Horas Credoras">Horas Credoras</option>
        <option value="Consulta Médica">Consulta Médica</option>
      </select>
    </div>

    <button id="saveItem">Salvar</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

/* === CONFIGURE AQUI O SEU FIREBASE === */
const firebaseConfig = {
  apiKey: "SUA_API_KEY",
  authDomain: "SEU_DOMINIO.firebaseapp.com",
  projectId: "SEU_PROJECT_ID",
  storageBucket: "SEU_BUCKET.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};
/* ==================================== */

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ---------------- VARIÁVEIS ----------------
let activeTab = 'ausencias';

// cores padrão por funcionário (ausências)
const cores = ['#FF9999','#99CCFF','#99FF99','#FFCC99','#CC99FF','#00CED1','#FF69B4','#F4A460'];
// cores fortes para férias (alternadas)
const coresFerias = ['#FF4500','#1E90FF','#228B22','#8B008B','#FF1493','#00008B','#8B0000','#FF8C00','#006400','#4B0082'];

const corFuncionario = {};      // map nome -> cor (ausências)
const corFeriasFuncionario = {}; // map nome -> cor (férias)
function atribuirCor(nome){
  if(!corFuncionario[nome]){
    const idx = Object.keys(corFuncionario).length % cores.length;
    corFuncionario[nome] = cores[idx];
  }
  return corFuncionario[nome];
}
function atribuirCorFerias(nome){
  if(!corFeriasFuncionario[nome]){
    const idx = Object.keys(corFeriasFuncionario).length % coresFerias.length;
    corFeriasFuncionario[nome] = coresFerias[idx];
  }
  return corFeriasFuncionario[nome];
}

// ---------------- FILTROS ----------------
const filtroFuncionario = document.getElementById('filtroFuncionario');
const buscaFuncionario = document.getElementById('buscaFuncionario');
let filtroNome = 'all';
let buscaTexto = '';

// snapshot cache (para re-render quando filtros mudam)
let lastSnapshot = null;

// ---------------- CALENDÁRIO PRINCIPAL ----------------
const modal = document.getElementById('modal');
const openModalBtn = document.getElementById('openModal');
const closeModalBtn = document.getElementById('closeModal');
const saveItemBtn = document.getElementById('saveItem');
const nomeInput = document.getElementById('nomeFuncionario');
const dataInicioInput = document.getElementById('dataInicio');
const dataFimInput = document.getElementById('dataFim');
const labelData2 = document.getElementById('labelData2');
const motivoSelect = document.getElementById('motivoSelect');
const motivoContainer = document.getElementById('motivoContainer');

const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
  initialView: 'dayGridMonth',
  locale: 'pt-br',
  headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
  events: [],
  dateClick(info) {
    modal.style.display = 'block';
    nomeInput.value = '';
    dataInicioInput.value = info.dateStr;
    dataFimInput.value = '';
    motivoSelect.value = '';
    if (activeTab === 'ferias') {
      motivoContainer.style.display = 'none';
      dataFimInput.style.display = 'block';
      labelData2.style.display = 'block';
    } else {
      motivoContainer.style.display = 'block';
      dataFimInput.style.display = 'none';
      labelData2.style.display = 'none';
    }
  },
  eventClick(info) {
    if (confirm(`Deseja remover ${info.event.title}?`)) {
      deleteDoc(doc(db, 'events', info.event.id));
    }
  },
  // evita problemas de timezone exibindo como allDay
  displayEventTime: false
});
calendar.render();

openModalBtn.onclick = () => {
  modal.style.display = 'block';
  nomeInput.value = ''; dataFimInput.value = '';
  motivoSelect.value = '';
  if(activeTab === 'ferias'){
    motivoContainer.style.display='none';
    dataFimInput.style.display='block'; labelData2.style.display='block';
  } else {
    motivoContainer.style.display='block';
    dataFimInput.style.display='none'; labelData2.style.display='none';
  }
};
closeModalBtn.onclick = () => modal.style.display='none';
window.onclick = e => { if (e.target == modal) modal.style.display='none'; };

// helper: retorna ISO string do dia seguinte (para tornar end **inclusivo** na exibição)
function displayEndInclusive(endStr){
  // input: "2025-12-04" -> output: "2025-12-05" (ISO date)
  if(!endStr) return null;
  const d = new Date(endStr + 'T00:00:00'); // force local midnight
  d.setDate(d.getDate() + 1);
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}

// ---------------- SALVAR EVENTO ----------------
saveItemBtn.onclick = async () => {
  const nome = nomeInput.value.trim();
  const inicio = dataInicioInput.value;
  const fim = dataFimInput.value || inicio;
  const motivo = motivoSelect.value;
  if (!nome) return alert('Digite o nome do funcionário!');
  if (!inicio) return alert('Selecione uma data!');
  if (activeTab === 'ausencias' && !motivo) return alert('Selecione o motivo da ausência!');

  // garantimos cores atribuídas (mas armazenamos a cor para referência)
  const cor = activeTab === 'ferias' ? atribuirCorFerias(nome) : atribuirCor(nome);

  const evento = {
    title: nome,
    start: inicio,   // ex: "2025-11-05"
    end: fim,        // ex: "2025-12-04" (inclusivo para o usuário)
    tipo: activeTab, // 'ausencias' ou 'ferias'
    motivo: motivo || '',
    color: cor
  };
  await addDoc(collection(db, 'events'), evento);
  modal.style.display = 'none';
};

// ---------------- RENDERIZAÇÃO A PARTIR DO SNAPSHOT ----------------
function renderFromSnapshot(snapshot){
  lastSnapshot = snapshot; // cache
  calendar.removeAllEvents();

  // atualizar select de funcionários
  const nomesSet = new Set();
  snapshot.forEach(docSnap => {
    const e = docSnap.data();
    if (e && e.title) nomesSet.add(e.title);
  });
  const nomes = Array.from(nomesSet).sort();
  filtroFuncionario.innerHTML = `<option value="all">Mostrar Todos</option>`;
  nomes.forEach(nome => filtroFuncionario.innerHTML += `<option value="${nome}">${nome}</option>`);

  // adicionar todos os eventos (aplicando filtros)
  snapshot.forEach(docSnap => {
    const e = docSnap.data();
    if(!e) return;
    // filtro por funcionário
    if(filtroNome !== 'all' && e.title !== filtroNome) return;
    // filtro por busca
    if(buscaTexto && !e.title.toLowerCase().includes(buscaTexto.toLowerCase())) return;

    const displayTitle = e.tipo === 'ferias'
      ? `${e.title} - Férias`
      : (e.motivo ? `${e.title} - ${e.motivo}` : e.title);

    // ajustar end para exibição (incluir último dia)
    const displayEnd = displayEndInclusive(e.end);

    calendar.addEvent({
      id: docSnap.id,
      title: displayTitle,
      start: e.start,
      end: displayEnd || undefined, // FullCalendar treats end exclusive -> usamos next day
      allDay: true,
      color: e.tipo === 'ferias' ? atribuirCorFerias(e.title) : (e.color || atribuirCor(e.title)),
      textColor: '#000'
    });
  });

  atualizarLegenda();
}

// ---------------- FIRESTORE SINGLE LISTENER ----------------
onSnapshot(collection(db, 'events'), (snapshot) => {
  renderFromSnapshot(snapshot);
});

// ---------------- FILTROS (sem criar novos listeners) ----------------
filtroFuncionario.onchange = () => {
  filtroNome = filtroFuncionario.value;
  if(lastSnapshot) renderFromSnapshot(lastSnapshot);
};
buscaFuncionario.oninput = () => {
  buscaTexto = buscaFuncionario.value.trim();
  if(lastSnapshot) renderFromSnapshot(lastSnapshot);
};

// ---------------- LEGENDA ----------------
function atualizarLegenda(){
  const legend = document.getElementById('legend');
  legend.innerHTML = '';
  // mostra legenda de férias com caixa padrão (vai listar nomes depois)
  legend.insertAdjacentHTML('beforeend', `<span class="legend-item"><div class="color-box" style="background:#000"></div>Legendas:</span>`);
  // férias coloridas por funcionário
  const nomesFerias = Object.keys(corFeriasFuncionario);
  if(nomesFerias.length > 0){
    nomesFerias.forEach(nome => {
      legend.insertAdjacentHTML('beforeend', `<span class="legend-item"><div class="color-box" style="background:${atribuirCorFerias(nome)}"></div>${nome} (Férias)</span>`);
    });
  }
  // ausências
  const nomesAusencias = Object.keys(corFuncionario).filter(n => !corFeriasFuncionario[n]);
  Object.keys(corFuncionario).forEach(nome => {
    legend.insertAdjacentHTML('beforeend', `<span class="legend-item"><div class="color-box" style="background:${atribuirCor(nome)}"></div>${nome}</span>`);
  });
}

// ---------------- TABS ----------------
document.getElementById('tabAusencias').onclick = () => { activeTab='ausencias'; mudarTab('tabAusencias'); };
document.getElementById('tabFerias').onclick = () => { activeTab='ferias'; mudarTab('tabFerias'); };
document.getElementById('tabDashboard').onclick = () => mostrarDashboard();

function mudarTab(id){
  document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active-tab'));
  document.getElementById(id).classList.add('active-tab');
  document.getElementById('calendar-container').style.display='block';
  document.getElementById('controls').style.display='block';
  document.getElementById('legend').style.display='flex';
  document.getElementById('stats').style.display='flex';
  document.getElementById('dashboardContainer').style.display='none';
}

// ---------------- PAINEL ANUAL ----------------
const dashboard = document.getElementById('dashboard');
const legendDashboard = document.getElementById('legendDashboard');
const anoSelect = document.getElementById('anoSelect');
const currentYear = new Date().getFullYear();
for(let y=currentYear-2;y<=currentYear+1;y++){
  let opt=document.createElement('option');
  opt.value=y; opt.text=y; if(y===currentYear) opt.selected=true;
  anoSelect.appendChild(opt);
}

function mostrarDashboard(){
  document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active-tab'));
  document.getElementById('tabDashboard').classList.add('active-tab');
  document.getElementById('calendar-container').style.display='none';
  document.getElementById('controls').style.display='none';
  document.getElementById('legend').style.display='none';
  document.getElementById('stats').style.display='none';
  document.getElementById('dashboardContainer').style.display='block';
  criarDashboard(parseInt(anoSelect.value));
}

let calendars = [];
function criarDashboard(ano){
  dashboard.innerHTML=''; calendars=[];
  const meses=['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
  meses.forEach((mes,i)=>{
    const div=document.createElement('div');
    div.className='calendar-mini';
    div.innerHTML=`<div class="month-title">${mes} ${ano}</div><div id="mini${i}"></div>`;
    dashboard.appendChild(div);
    const calEl = document.getElementById(`mini${i}`);
    const cal = new FullCalendar.Calendar(calEl,{initialView:'dayGridMonth',locale:'pt-br',headerToolbar:false,height:220,events:[]});
    cal.gotoDate(`${ano}-${String(i+1).padStart(2,'0')}-01`);
    cal.render();
    calendars.push(cal);
  });
  carregarEventosDashboard(ano);
}

function carregarEventosDashboard(ano){
  // usamos lastSnapshot para evitar criar listener duplicado
  if(!lastSnapshot) return;
  calendars.forEach(cal => cal.removeAllEvents());
  lastSnapshot.forEach(docSnap => {
    const e = docSnap.data();
    if(!e) return;
    const inicio = new Date(e.start + 'T00:00:00');
    const fim = new Date(e.end + 'T00:00:00');
    // para exibição no dashboard também usamos end +1 dia
    const fimExib = new Date(fim);
    fimExib.setDate(fimExib.getDate() + 1);

    // para cada mês do ano, se o evento intersecta o mês -> adiciona no mini calendar
    for(let m=0;m<12;m++){
      const primeiroDia = new Date(ano, m, 1, 0,0,0);
      const ultimoDia = new Date(ano, m+1, 0, 23,59,59);
      if(fimExib >= primeiroDia && inicio <= ultimoDia){
        const cal = calendars[m];
        if(!cal) continue;
        cal.addEvent({
          title: e.tipo === 'ferias' ? `${e.title} - Férias` : (e.motivo ? `${e.title} - ${e.motivo}` : e.title),
          start: e.start,
          end: displayEndInclusive(e.end),
          allDay: true,
          color: e.tipo === 'ferias' ? atribuirCorFerias(e.title) : (e.color || atribuirCor(e.title)),
          textColor: '#000'
        });
      }
    }
  });
  atualizarLegendaDashboard();
}

function atualizarLegendaDashboard(){
  legendDashboard.innerHTML = '';
  if(!lastSnapshot) return;
  const nomes = new Set();
  lastSnapshot.forEach(d => { const e = d.data(); if(e && e.title) nomes.add(e.title); });
  Array.from(nomes).sort().forEach(nome => {
    legendDashboard.innerHTML += `<span class="legend-item"><div class="color-box" style="background:${atribuirCorFerias(nome)}"></div>${nome}</span>`;
  });
}

anoSelect.onchange = () => criarDashboard(parseInt(anoSelect.value));

// ---------------- EXPORTAR PDF ----------------
async function exportPdf(divId,nomeArquivo){
  const { jsPDF } = window.jspdf;
  const input = document.getElementById(divId);
  const canvas = await html2canvas(input,{scale:2});
  const img = canvas.toDataURL('image/png');
  const pdf = new jsPDF('l','mm','a4');
  const imgProps = pdf.getImageProperties(img);
  const pdfWidth = pdf.internal.pageSize.getWidth();
  const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
  pdf.addImage(img,'PNG',0,0,pdfWidth,pdfHeight);
  pdf.save(nomeArquivo);
}
document.getElementById('exportPdf').onclick = () => exportPdf('calendar-container','Eventos.pdf');
document.getElementById('exportDashboardPdf').onclick = () => exportPdf('dashboardContainer','Painel_Anual.pdf');

</script>
</body>
</html>
