<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle de Ausências, Férias e Painel Anual</title>
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<style>
body { font-family: Arial, sans-serif; margin:20px; text-align:center; }
h1 { margin-bottom:10px; }
#tabs { margin-bottom:10px; }
.tab-button { padding:8px 15px; margin:0 5px; cursor:pointer; font-size:14px; }
.active-tab { background-color:#3788d8; color:#fff; border-radius:4px; }
#calendar-container { display:block; }
#calendar { max-width:1000px; margin:20px auto; }
button, select, input { margin:5px; padding:6px 10px; font-size:14px; }
.modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.5);}
.modal-content { background-color:#fefefe; margin:10% auto; padding:20px; border-radius:8px; width:320px; text-align:left; position:relative;}
.close { position:absolute; top:10px; right:15px; font-size:20px; cursor:pointer; }
.modal input, .modal select { width:100%; margin:5px 0 15px 0; padding:8px; box-sizing:border-box; }
.modal button { width:100%; }
#legend, #stats { max-width:900px; margin:10px auto; text-align:left; display:flex; flex-wrap:wrap; justify-content:center; }
.legend-item { margin:5px 10px; display:flex; align-items:center; font-size:14px; }
.color-box { width:15px; height:15px; margin-right:5px; border:1px solid #000; }

/* Painel anual */
#dashboardContainer { display:none; }
#dashboard { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; max-width:1200px; margin:0 auto; }
.calendar-mini { border:1px solid #ccc; border-radius:6px; padding:5px; background:#fafafa; }
.month-title { font-weight:bold; background:#eee; border-radius:4px; padding:3px; margin-bottom:4px; }
</style>
</head>
<body>

<h1>Controle de Ausências, Férias e Painel Anual</h1>

<div id="tabs">
  <button class="tab-button active-tab" id="tabAusencias">Ausências</button>
  <button class="tab-button" id="tabFerias">Férias</button>
  <button class="tab-button" id="tabDashboard">Painel Anual</button>
</div>

<div id="controls">
  <button id="openModal">Adicionar</button>
  <select id="filtroFuncionario"><option value="all">Mostrar Todos</option></select>
  <input type="text" id="buscaFuncionario" placeholder="Buscar por nome...">
  <select id="viewSelect">
    <option value="dayGridMonth">Mensal</option>
    <option value="timeGridWeek">Semanal</option>
    <option value="timeGridDay">Diária</option>
  </select>
</div>

<div id="legend"></div>
<div id="calendar-container"><div id="calendar"></div></div>

<!-- Painel anual -->
<div id="dashboardContainer">
  <div id="controlsDashboard">
    <select id="anoSelect"></select>
  </div>
  <div id="legendDashboard"></div>
  <div id="dashboard"></div>
</div>

<!-- Modal -->
<div id="modal" class="modal">
  <div class="modal-content">
    <span class="close" id="closeModal">&times;</span>
    <h3 id="modalTitle">Adicionar</h3>
    <label>Nome do Funcionário:</label>
    <input type="text" id="nomeFuncionario" placeholder="Ex: João">
    <label id="labelData1">Data Início:</label>
    <input type="date" id="dataInicio">
    <label id="labelData2" style="display:none">Data Fim:</label>
    <input type="date" id="dataFim" style="display:none">
    <div id="motivoContainer">
      <label>Motivo da Ausência:</label>
      <select id="motivoSelect">
        <option value="">Selecione...</option>
        <option value="Abonada">Abonada</option>
        <option value="Horas Credoras">Horas Credoras</option>
        <option value="Consulta Médica">Consulta Médica</option>
      </select>
    </div>
    <button id="saveItem">Salvar</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbxiwPs0UotDZC5GT2S5VxlVRCKZrv8_VmA9TVnJS2fOziKW5d-cbI6f6V7JkmtvBjnCLw/exec';
  
  
  
let activeTab = 'ausencias';
const cores = ['#FF9999','#99CCFF','#99FF99','#FFCC99','#CC99FF','#00CED1','#FF69B4','#F4A460'];
const coresFerias = ['#FF4500','#1E90FF','#228B22','#8B008B','#FF1493','#00008B','#8B0000','#FF8C00','#006400','#4B0082'];
const corFuncionario = {};
const corFeriasFuncionario = {};

function atribuirCor(nome){
  if(!corFuncionario[nome]){
    const idx = Object.keys(corFuncionario).length % cores.length;
    corFuncionario[nome] = cores[idx];
  }
  return corFuncionario[nome];
}
function atribuirCorFerias(nome){
  if(!corFeriasFuncionario[nome]){
    const idx = Object.keys(corFeriasFuncionario).length % coresFerias.length;
    corFeriasFuncionario[nome] = coresFerias[idx];
  }
  return corFeriasFuncionario[nome];
}

const filtroFuncionario = document.getElementById('filtroFuncionario');
const buscaFuncionario = document.getElementById('buscaFuncionario');
let filtroNome = 'all';
let buscaTexto = '';
let lastEvents = [];

const modal = document.getElementById('modal');
const openModalBtn = document.getElementById('openModal');
const closeModalBtn = document.getElementById('closeModal');
const saveItemBtn = document.getElementById('saveItem');
const nomeInput = document.getElementById('nomeFuncionario');
const dataInicioInput = document.getElementById('dataInicio');
const dataFimInput = document.getElementById('dataFim');
const labelData2 = document.getElementById('labelData2');
const motivoSelect = document.getElementById('motivoSelect');
const motivoContainer = document.getElementById('motivoContainer');

const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
  initialView: 'dayGridMonth',
  locale: 'pt-br',
  headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
  events: [],
  dateClick(info) {
    modal.style.display='block';
    nomeInput.value=''; dataFimInput.value=''; motivoSelect.value='';
    dataInicioInput.value = info.dateStr;
    if(activeTab==='ferias'){ motivoContainer.style.display='none'; dataFimInput.style.display='block'; labelData2.style.display='block'; }
    else{ motivoContainer.style.display='block'; dataFimInput.style.display='none'; labelData2.style.display='none'; }
  }
});
calendar.render();

openModalBtn.onclick = ()=>{ modal.style.display='block'; nomeInput.value=''; dataFimInput.value=''; motivoSelect.value=''; 
if(activeTab==='ferias'){ motivoContainer.style.display='none'; dataFimInput.style.display='block'; labelData2.style.display='block'; }
else{ motivoContainer.style.display='block'; dataFimInput.style.display='none'; labelData2.style.display='none'; } };
closeModalBtn.onclick = ()=>modal.style.display='none';
window.onclick = e=>{ if(e.target==modal) modal.style.display='none'; };

function displayEndInclusive(endStr){
  if(!endStr) return null;
  const d=new Date(endStr+'T00:00:00');
  d.setDate(d.getDate()+1);
  const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}

// ---------------- SALVAR EVENTO ----------------
saveItemBtn.onclick = async ()=>{
  const nome = nomeInput.value.trim();
  const inicio = dataInicioInput.value;
  const fim = dataFimInput.value || inicio;
  const motivo = motivoSelect.value;
  if(!nome) return alert('Digite o nome do funcionário!');
  if(!inicio) return alert('Selecione uma data!');
  if(activeTab==='ausencias' && !motivo) return alert('Selecione o motivo da ausência!');
  const cor = activeTab==='ferias'? atribuirCorFerias(nome) : atribuirCor(nome);
  const evento = { nome, inicio, fim, tipo:activeTab, motivo:motivo||'', cor };

  try{
    const res = await fetch(API_URL,{
      method:'POST',
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(evento)
    });
    const result = await res.json();
    if(result.status==='ok'){
      alert('Evento salvo com sucesso!');
      modal.style.display='none'; nomeInput.value=''; dataInicioInput.value=''; dataFimInput.value=''; motivoSelect.value='';
      carregarEventos();
    }else{ alert('Erro ao salvar evento: '+result.message); }
  }catch(err){ console.error('Erro ao salvar evento:', err); alert('Não foi possível salvar o evento.'); }
};

// ---------------- CARREGAR EVENTOS ----------------
async function carregarEventos(){
  try{
    const res = await fetch(API_URL);
    const data = await res.json();
    lastEvents = data; // array de objetos {nome,inicio,fim,tipo,motivo,cor}
    renderCalendar();
  }catch(err){ console.error('Erro ao carregar eventos:', err); }
}

function renderCalendar(){
  calendar.removeAllEvents();
  const nomesSet = new Set();
  lastEvents.forEach(e=>{ if(e.nome) nomesSet.add(e.nome); });
  filtroFuncionario.innerHTML = '<option value="all">Mostrar Todos</option>';
  Array.from(nomesSet).sort().forEach(n=> filtroFuncionario.innerHTML += `<option value="${n}">${n}</option>`);
  lastEvents.forEach(e=>{
    if(filtroNome!=='all' && e.nome!==filtroNome) return;
    if(buscaTexto && !e.nome.toLowerCase().includes(buscaTexto.toLowerCase())) return;
    const displayTitle = e.tipo==='ferias'? `${e.nome} - Férias` : (e.motivo? `${e.nome} - ${e.motivo}`: e.nome);
    calendar.addEvent({ title:displayTitle, start:e.inicio, end:displayEndInclusive(e.fim), allDay:true, color:e.cor, textColor:'#000' });
  });
}

filtroFuncionario.onchange = ()=>{ filtroNome=filtroFuncionario.value; renderCalendar(); };
buscaFuncionario.oninput = ()=>{ buscaTexto=buscaFuncionario.value.trim(); renderCalendar(); };

// ---------------- TABS ----------------
document.getElementById('tabAusencias').onclick=()=>{ activeTab='ausencias'; mudarTab('tabAusencias'); };
document.getElementById('tabFerias').onclick=()=>{ activeTab='ferias'; mudarTab('tabFerias'); };
document.getElementById('tabDashboard').onclick=()=>mostrarDashboard();

function mudarTab(id){ document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active-tab')); document.getElementById(id).classList.add('active-tab'); 
document.getElementById('calendar-container').style.display='block'; document.getElementById('controls').style.display='block'; document.getElementById('legend').style.display='flex';
document.getElementById('dashboardContainer').style.display='none'; atualizarLegenda(); }

function atualizarLegenda(){
  const legend=document.getElementById('legend'); legend.innerHTML='';
  const nomesFerias = Array.from(new Set(lastEvents.filter(e=>e.tipo==='ferias').map(e=>e.nome)));
  nomesFerias.forEach(nome=>legend.insertAdjacentHTML('beforeend',`<span class="legend-item"><div class="color-box" style="background:${atribuirCorFerias(nome)}"></div>${nome} (Férias)</span>`));
  const nomesAusencias = Array.from(new Set(lastEvents.filter(e=>e.tipo==='ausencias').map(e=>e.nome)));
  nomesAusencias.forEach(nome=>legend.insertAdjacentHTML('beforeend',`<span class="legend-item"><div class="color-box" style="background:${atribuirCor(nome)}"></div>${nome}</span>`));
}

// ---------------- DASHBOARD ----------------
const dashboard=document.getElementById('dashboard');
const legendDashboard=document.getElementById('legendDashboard');
const anoSelect=document.getElementById('anoSelect');
const currentYear=new Date().getFullYear();
for(let y=currentYear-2;y<=currentYear+1;y++){ let opt=document.createElement('option'); opt.value=y; opt.text=y; if(y===currentYear) opt.selected=true; anoSelect.appendChild(opt); }

function mostrarDashboard(){
  document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active-tab')); document.getElementById('tabDashboard').classList.add('active-tab');
  document.getElementById('calendar-container').style.display='none'; document.getElementById('controls').style.display='none'; document.getElementById('legend').style.display='none';
  document.getElementById('dashboardContainer').style.display='block'; criarDashboard(parseInt(anoSelect.value));
}

let calendars=[];
function criarDashboard(ano){
  dashboard.innerHTML=''; calendars=[];
  const meses=['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
  meses.forEach((mes,i)=>{
    const div=document.createElement('div'); div.className='calendar-mini'; div.innerHTML=`<div class="month-title">${mes} ${ano}</div><div id="mini${i}"></div>`;
    dashboard.appendChild(div);
    const calEl=document.getElementById(`mini${i}`);
    const cal=new FullCalendar.Calendar(calEl,{initialView:'dayGridMonth',locale:'pt-br',headerToolbar:false,height:220,events:[]});
    cal.gotoDate(`${ano}-${String(i+1).padStart(2,'0')}-01`); cal.render(); calendars.push(cal);
  });
  carregarEventosDashboard(ano);
}

function carregarEventosDashboard(ano){
  calendars.forEach(cal=>cal.removeAllEvents());
  lastEvents.forEach(e=>{
    const inicio=new Date(e.inicio+'T00:00:00'); const fim=new Date(e.fim+'T00:00:00'); fim.setDate(fim.getDate()+1);
    for(let m=0;m<12;m++){
      const primeiroDia=new Date(ano,m,1); const ultimoDia=new Date(ano,m+1,0);
      if(fim>=primeiroDia && inicio<=ultimoDia){
        const cal=calendars[m];
        cal.addEvent({ title:e.tipo==='ferias'? `${e.nome} - Férias` : (e.motivo?`${e.nome} - ${e.motivo}`: e.nome),
          start:e.inicio, end:displayEndInclusive(e.fim), allDay:true, color:e.cor, textColor:'#000' });
      }
    }
  });
  legendDashboard.innerHTML='';
  Array.from(new Set(lastEvents.map(e=>e.nome))).sort().forEach(nome=> legendDashboard.innerHTML += `<span class="legend-item"><div class="color-box" style="background:${atribuirCorFerias(nome)}"></div>${nome}</span>`);
}

anoSelect.onchange=()=> criarDashboard(parseInt(anoSelect.value));

// ---------------- INICIAL ----------------
carregarEventos();

</script>
</body>
</html>



